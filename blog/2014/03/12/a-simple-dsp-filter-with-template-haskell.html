<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head lang="en">
    <title>A simple DSP filter with Template Haskell</title>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta name="description" content="">
    <meta name="keywords" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no,minimal-ui">
    <script type="text/javascript" src="/js/client.js"></script>
  </head>
  <body ng-app="application">
    <div class="site_wrapper">
      <div class="sidebar"> <img class="sidebar__picture">
        <div class="sidebar__name">Vittorio Zaccaria</div>
        <div class="sidebar__address">Politecnico di Milano</div>
        <ul class="sidebar__link_list">
          <li onclick="location.href=&apos;&apos;" style="cursor: pointer" class="sidebar__link_item"><span class="sidebar__link_item__icon fa-stack"><i class="fa fa-stack-2x fa-circle"></i><i class="sidebar__link_item__icon__inner fa fa-stack-1x fa-inverse fa-home"></i></span>
            <div class="sidebar__link_item__name">Home</div>
          </li>
          <li onclick="location.href=&apos;/research.html&apos;" style="cursor: pointer" class="sidebar__link_item"><span class="sidebar__link_item__icon fa-stack"><i class="fa fa-stack-2x fa-circle"></i><i class="sidebar__link_item__icon__inner fa fa-stack-1x fa-inverse fa-flask"></i></span>
            <div class="sidebar__link_item__name">Research</div>
          </li>
          <li onclick="location.href=&apos;/blog.html&apos;" style="cursor: pointer" class="sidebar__link_item"><span class="sidebar__link_item__icon fa-stack"><i class="fa fa-stack-2x fa-circle"></i><i class="sidebar__link_item__icon__inner fa fa-stack-1x fa-inverse fa-quote-left"></i></span>
            <div class="sidebar__link_item__name">Blog</div>
          </li>
          <li onclick="location.href=&apos;/projects.html&apos;" style="cursor: pointer" class="sidebar__link_item"><span class="sidebar__link_item__icon fa-stack"><i class="fa fa-stack-2x fa-circle"></i><i class="sidebar__link_item__icon__inner fa fa-stack-1x fa-inverse fa-floppy-o"></i></span>
            <div class="sidebar__link_item__name">Projects</div>
          </li>
          <li onclick="location.href=&apos;/teaching.html&apos;" style="cursor: pointer" class="sidebar__link_item"><span class="sidebar__link_item__icon fa-stack"><i class="fa fa-stack-2x fa-circle"></i><i class="sidebar__link_item__icon__inner fa fa-stack-1x fa-inverse fa-graduation-cap"></i></span>
            <div class="sidebar__link_item__name">Teaching</div>
          </li>
          <li onclick="location.href=&apos;http://www.vittoriozaccaria.net/deposit/cv.pdf&apos;" style="cursor: pointer" class="sidebar__link_item"><span class="sidebar__link_item__icon fa-stack"><i class="fa fa-stack-2x fa-circle"></i><i class="sidebar__link_item__icon__inner fa fa-stack-1x fa-inverse fa-user"></i></span>
            <div class="sidebar__link_item__name">CV</div>
          </li>
          <li onclick="location.href=&apos;/videos.html&apos;" style="cursor: pointer" class="sidebar__link_item"><span class="sidebar__link_item__icon fa-stack"><i class="fa fa-stack-2x fa-circle"></i><i class="sidebar__link_item__icon__inner fa fa-stack-1x fa-inverse fa-youtube-play"></i></span>
            <div class="sidebar__link_item__name">Videos</div>
          </li>
          <li onclick="location.href=&apos;/address.html&apos;" style="cursor: pointer" class="sidebar__link_item"><span class="sidebar__link_item__icon fa-stack"><i class="fa fa-stack-2x fa-circle"></i><i class="sidebar__link_item__icon__inner fa fa-stack-1x fa-inverse fa-map-marker"></i></span>
            <div class="sidebar__link_item__name">Address</div>
          </li>
        </ul>
        <div class="sidebar__bottom"> 
          <div onclick="location.href=&apos;http://www.linkedin.com/in/vzaccaria&apos;" style="cursor: pointer" class="sidebar__bottom__button"><i class="fa fa-linkedin-square"></i></div>
          <div onclick="location.href=&apos;http://twitter.com/_vzaccaria_&apos;" style="cursor: pointer" class="sidebar__bottom__button"><i class="fa fa-twitter-square"></i></div>
          <div onclick="location.href=&apos;https://plus.google.com/116322227495215922957/about&apos;" style="cursor: pointer" class="sidebar__bottom__button"><i class="fa fa-google-plus-square"></i></div>
        </div>
      </div>
      <div class="site_container">
        <div class="post_container">
          <div class="post_container__post__title">A simple DSP filter with Template Haskell</div>
          <div class="post_container__post__subtitle"> 
            <div class="post_container__post__date"> <i class="fa fa-calendar-o"> </i>
              <div class="post_container__post__date_value">Wednesday, March 12th 2014</div>
            </div>
            <div class="post_container__post__category"> <i class="fa fa-flag-o"> </i>
              <div class="post_container__post__category_value">blog</div>
            </div>
            <div class="post_container__post__tags"> <i class="fa fa-tags"></i>
              <div class="post_container__post__tag">haskell</div>
              <div class="post_container__post__tag">digital signal processing</div>
            </div>
            <div class="share_buttons"> 
              <div class="share_buttons__message">Share: </div>
              <div style="cursor: pointer" class="share_buttons__share_reddit"><i class="fa fa-reddit"> </i></div>
              <div style="cursor: pointer" class="share_buttons__share_twitter"><i class="fa fa-twitter"></i></div>
            </div>
          </div>
          <div class="post_text"><p><em>Note: This is part 2 of small tutorial on Template Haskell I wrote on my blog; the tutorial is composed of <a href="http://www.vittoriozaccaria.net/blog/2014/02/24/towards-template-programming-with-haskell.html">part1</a>, <a href="http://www.vittoriozaccaria.net/blog/2014/03/12/implementing-a-simple-dsp-filter-library-with-template-haskell.html">part 2</a> and <a href="http://www.vittoriozaccaria.net/blog/2014/03/21/symbolically-optimize-dsp-filters-with-template-haskell.html">part 3</a></em>.</p>
<p><a href="http://www.vittoriozaccaria.net/blog/2014/02/24/towards-template-programming-with-haskell.html">In a previous post</a> I&#39;ve summed up the basic steps to programmatically create a simple Haskell program using <a href="http://www.haskell.org/haskellwiki/Template_Haskell">Template Haskell</a>. </p>
<p>In this post, I&#39;ll show how you can write a reusable <a href="http://en.wikipedia.org/wiki/Finite_impulse_response"><em>finite impulse response filter</em></a> in Template Haskell. </p>
<p><strong>Question</strong>: </p>
<blockquote>
<p>But why do I have to symbolically generate the FIR filter with Template Haskell? What&#39;s the difference with respect to a pure definition in plain Haskell?</p>
</blockquote>
<p><strong>Answer</strong>:</p>
<blockquote>
<p>Template Haskell allows to generate code at compile time. This means that, if the coefficients of the filter are known at compile time, the code of the filter will be automatically optimized by the Haskell compiler. So, you will get constant propagation and other optimizations for free.</p>
</blockquote>
<h1 id="pre-requirements">Pre-requirements</h1>
<p>Check out the pre-requirements from <a href="http://www.vittoriozaccaria.net/blog/2014/02/24/towards-template-programming-with-haskell.html">my previous post</a>.</p>
<h1 id="fir-filter-definition">FIR filter definition</h1>
<p>Given an input array \(x\) and an array of \(N+1\) coefficients \(c\), 
we define the output \(y\) of the FIR filter as follows:</p>
<p>\begin{equation}
y_n = \sum_{i=0}^{N} c_i * x_{n-i}
\end{equation}</p>
<p>In the following paragraphs, <code>x</code>,<code>y</code> and <code>c</code> will be treated as Haskell lists.
Let&#39;s focus now on the computation of a single sample of \(y\); we want to write a function that given:</p>
<ul>
<li>a list of coefficients <code>c</code> and </li>
<li>the AST of the input list <code>x</code></li>
</ul>
<p>returns the AST for computing <code>y</code>. The function has the following name and type:</p>
<pre><code>flt0 :: [Rational] -&gt; ( Q Exp -&gt; Q Exp )
</code></pre><p>where <code>[Rational]</code> represents the type of the coefficient list while the return type:</p>
<pre><code>( Q Exp -&gt; Q Exp )
</code></pre><p>means that we are returning a function from AST to AST. An example invocation of the latter can be the following:</p>
<pre><code>(flt0 [0, 1]) [| x |] 
</code></pre><p>where <code>[| x |]</code> is the Template Haskell notation for the AST associated with the input list <code>x</code>. This should generate an AST representing the following expression[^1] :</p>
<pre><code>(0%0) * x!!0 + (1%1) * x!!1
</code></pre><p>where the coefficients <code>[0,1]</code> have been used to unroll the convolution implied by the filter definition. Instead, <code>[| x |]</code> is effectively treated as a list by using the indexing operator <code>!!</code>.</p>
<h1 id="let-s-write-our-filter-generator-">Let&#39;s write our filter generator.</h1>
<p>We define the top-level function <code>flt0</code> as</p>
<pre><code>module Filt where 

flt0 c = \x -&gt; dotv (c) x (length c) 0
</code></pre><p>where </p>
<ul>
<li><code>c</code> is the coefficient list</li>
<li><code>x</code> is the AST of the input signal</li>
<li><code>dotv</code> is a recursive function that produces the AST of the dot product between <code>c</code> and <code>x</code>. </li>
<li>The third parameter to <code>dotv</code> represents the overall number of coefficients to be consumed </li>
<li>The fourth parameter to <code>dotv</code> is the starting index within <code>x</code> to be considered for the product.</li>
</ul>
<h1 id="the-dot-product">The Dot Product</h1>
<p>The dot product is defined as follows:</p>
<pre><code>dotv :: [Rational] -&gt; Q Exp -&gt; Int -&gt; Int -&gt; Q Exp 
dotv c x n m = 
    let coeff = head c
        p = [| coeff * ($x !! m) |]
        in  if n == 1
            then p
            else [| $p + $(Filt.dotv (tail c) x (n-1) (m+1)) |]
</code></pre><p>If the coefficient list is composed of one element, the function will return the AST of <code>coeff * $x !! m</code> where <code>$x</code> will splice the AST of the input signal.
Instead, if we have a number of coefficients greater than one, we will concatenate the AST of <code>coeff * $x !! m</code> to the dot product between the remaining part of the coefficients <code>tail c</code> and the remaining part of the input vector.</p>
<h1 id="using-the-filter-generator">Using the filter generator</h1>
<p>To use our filter generator, we need to define another module (let&#39;s call it Main):</p>
<pre><code>module Main where

import Language.Haskell.TH.Syntax
import Language.Haskell.TH.Ppr
import Language.Haskell.TH
import Filt
</code></pre><p>we define the AST of a lambda function as follows:</p>
<pre><code>myfilter = [| \x -&gt; $(Filt.flt0 [0, 1] [| x |]) |]
</code></pre><p>If we print the code of this filter:</p>
<pre><code>printCode :: Q Exp -&gt; IO ()
printCode ast = runQ ast &gt;&gt;= putStrLn . pprint

main = printCode $ myfilter
</code></pre><p>we get effectively:</p>
<pre><code>\x_0 -&gt; ((0 % 1) GHC.Num.* (x_0 GHC.List.!! 0)) GHC.Num.+ ((1 % 1) GHC.Num.* (x_0 GHC.List.!! 1))
</code></pre><p>which is the unfolded Haskell definition of the original filter.</p>
<h1 id="bonus-symbolic-filter-concatenation">Bonus: symbolic filter concatenation</h1>
<p>As the parameter <code>x</code> is defined generically as an AST, it can be the one generated by another call of <code>flt0</code>. This means that we can generate symbolically also a sequence of chained filters:</p>
<pre><code>myfilter2 = [| \x -&gt; $(Filt.flt0 [2, 3] $ Filt.flt0 [0, 1] [| x |]) |]
</code></pre><p>Where a filter with coefficients [2, 3] is chained with the previous one, yielding:</p>
<pre><code>\x_0 -&gt; ((2 % 1) GHC.Num.* ((((0 % 1) GHC.Num.* (x_0 GHC.List.!! 0)) GHC.Num.+ ((1 % 1) GHC.Num.* (x_0 GHC.List.!! 1))) GHC.List.!! 0)) GHC.Num.+ ((3 % 1) GHC.Num.* ((((0 % 1) GHC.Num.* (x_0 GHC.List.!! 0)) GHC.Num.+ ((1 % 1) GHC.Num.* (x_0 GHC.List.!! 1))) GHC.List.!! 1))
</code></pre><h1 id="where-to-go-from-here">Where to go from here</h1>
<p>In the next post, we will see how to programmatically simplify these expressions to yield more efficient filters by applying general and domain specific optimizations. </p>
<p>[^1]: I simplified the operators representation by removing <code>GHC.List</code> and <code>GHC.Num</code>.</p>
</div>
          <script src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_SVG"></script>
          <div id="disqus_thread" class="post_container__comments"> 
            <script>(function() {
  var disqus_shortname, dsq;

  disqus_shortname = 'vittoriozaccaria';

  dsq = document.createElement('script');

  dsq.type = 'text/javascript';

  dsq.async = true;

  dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';

  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);

}).call(this);

            </script><a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>