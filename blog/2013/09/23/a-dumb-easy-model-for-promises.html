<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head lang="en">
    <title>A dumb easy model for promises</title>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta name="description" content="">
    <meta name="keywords" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no,minimal-ui">
    <script type="text/javascript" src="/js/client.js"></script>
    <link rel="icon" type="image/png" href="/img/favicon.png">
  </head>
  <body ng-app="application">
    <div class="site_wrapper">
      <div class="sidebar"> <img class="sidebar__picture">
        <div class="sidebar__name">Vittorio Zaccaria</div>
        <div class="sidebar__address">Politecnico di Milano</div>
        <ul class="sidebar__link_list">
          <li onclick="location.href=&apos;/&apos;" style="cursor: pointer" class="sidebar__link_item"><span class="sidebar__link_item__icon fa-stack"><i class="fa fa-stack-2x fa-circle"></i><i class="sidebar__link_item__icon__inner fa fa-stack-1x fa-inverse fa-home"></i></span>
            <div class="sidebar__link_item__name">Home</div>
          </li>
          <li onclick="location.href=&apos;/research.html&apos;" style="cursor: pointer" class="sidebar__link_item"><span class="sidebar__link_item__icon fa-stack"><i class="fa fa-stack-2x fa-circle"></i><i class="sidebar__link_item__icon__inner fa fa-stack-1x fa-inverse fa-flask"></i></span>
            <div class="sidebar__link_item__name">Research</div>
          </li>
          <li onclick="location.href=&apos;/blog.html&apos;" style="cursor: pointer" class="sidebar__link_item"><span class="sidebar__link_item__icon fa-stack"><i class="fa fa-stack-2x fa-circle"></i><i class="sidebar__link_item__icon__inner fa fa-stack-1x fa-inverse fa-quote-left"></i></span>
            <div class="sidebar__link_item__name">Blog</div>
          </li>
          <li onclick="location.href=&apos;/projects.html&apos;" style="cursor: pointer" class="sidebar__link_item"><span class="sidebar__link_item__icon fa-stack"><i class="fa fa-stack-2x fa-circle"></i><i class="sidebar__link_item__icon__inner fa fa-stack-1x fa-inverse fa-floppy-o"></i></span>
            <div class="sidebar__link_item__name">Projects</div>
          </li>
          <li onclick="location.href=&apos;/teaching.html&apos;" style="cursor: pointer" class="sidebar__link_item"><span class="sidebar__link_item__icon fa-stack"><i class="fa fa-stack-2x fa-circle"></i><i class="sidebar__link_item__icon__inner fa fa-stack-1x fa-inverse fa-graduation-cap"></i></span>
            <div class="sidebar__link_item__name">Teaching</div>
          </li>
          <li onclick="location.href=&apos;/deposit/cv.pdf&apos;" style="cursor: pointer" class="sidebar__link_item"><span class="sidebar__link_item__icon fa-stack"><i class="fa fa-stack-2x fa-circle"></i><i class="sidebar__link_item__icon__inner fa fa-stack-1x fa-inverse fa-user"></i></span>
            <div class="sidebar__link_item__name">CV</div>
          </li>
          <li onclick="location.href=&apos;/videos.html&apos;" style="cursor: pointer" class="sidebar__link_item"><span class="sidebar__link_item__icon fa-stack"><i class="fa fa-stack-2x fa-circle"></i><i class="sidebar__link_item__icon__inner fa fa-stack-1x fa-inverse fa-youtube-play"></i></span>
            <div class="sidebar__link_item__name">Videos</div>
          </li>
          <li onclick="location.href=&apos;/address.html&apos;" style="cursor: pointer" class="sidebar__link_item"><span class="sidebar__link_item__icon fa-stack"><i class="fa fa-stack-2x fa-circle"></i><i class="sidebar__link_item__icon__inner fa fa-stack-1x fa-inverse fa-map-marker"></i></span>
            <div class="sidebar__link_item__name">Address</div>
          </li>
        </ul>
        <div class="sidebar__bottom"> 
          <div onclick="location.href=&apos;http://www.linkedin.com/in/vzaccaria&apos;" style="cursor: pointer" class="sidebar__bottom__button"><i class="fa fa-linkedin-square"></i></div>
          <div onclick="location.href=&apos;http://twitter.com/_vzaccaria_&apos;" style="cursor: pointer" class="sidebar__bottom__button"><i class="fa fa-twitter-square"></i></div>
          <div onclick="location.href=&apos;https://plus.google.com/116322227495215922957/about&apos;" style="cursor: pointer" class="sidebar__bottom__button"><i class="fa fa-google-plus-square"></i></div>
        </div>
      </div>
      <div class="site_container">
        <div class="post_container">
          <div class="post_container__post__title">A dumb easy model for promises</div>
          <div class="post_container__post__subtitle"> 
            <div class="post_container__post__date"> <i class="fa fa-calendar-o"> </i>
              <div class="post_container__post__date_value">Monday, September 23rd 2013</div>
            </div>
            <div class="post_container__post__category"> <i class="fa fa-flag-o"> </i>
              <div class="post_container__post__category_value">blog</div>
            </div>
            <div class="post_container__post__tags"> <i class="fa fa-tags"></i>
              <div class="post_container__post__tag">promises</div>
              <div class="post_container__post__tag">concurrent</div>
              <div class="post_container__post__tag">asynchronous</div>
              <div class="post_container__post__tag">javascript</div>
            </div>
            <div class="share_buttons"> 
              <div class="share_buttons__message">Share: </div>
              <div style="cursor: pointer" class="share_buttons__share_reddit"><i class="fa fa-reddit"> </i></div>
              <div style="cursor: pointer" class="share_buttons__share_twitter"><i class="fa fa-twitter"></i></div>
            </div>
          </div>
          <div class="post_text"><p><em>April 2nd, 2014: the post has been edited to fix some errors that were present in the original article. Thanks to @steve for having pointed that out</em>.</p>
<p><a href="http://en.wikipedia.org/wiki/Futures_and_promises">Promises</a> are significantly taking ground as a programming construct for asynchronous systems such as web applications. In its simplest form, a <em>promise</em> represents the state of the result of some future computation.</p>
<p>I was introduced recently to this construct when studying <a href="http://api.jquery.com/promise/">jQuery</a> and <a href="http://angularjs.org/">AngularJS</a>. At the beginning, I was not able to wrap my head around it. While I understood the basic callback mechanism — allowing to be notified when the computation is finished — I struggled a lot capturing the efficiency with which promises allow to easily <em>compose</em> asynchronous programs.</p>
<h2 id="enter-petri-nets">Enter Petri nets</h2>
<p><a href="http://en.wikipedia.org/wiki/Petri_net">Petri nets</a> have helped me a lot while creating an easy mental/visual model of promises (and their composition patterns). </p>
<p>In this post, I will refer to the <a href="http://promises-aplus.github.io/promises-spec/">&quot;Promises/A+&quot;</a> specification. I assume you have already some basic knowledge of it — especially of the special cases. Besides, I will not indulge in any mathematical notation of Petri Nets here. If you are interested, I&#39;ve put some suggested reading link at the end of this post.</p>
<h2 id="basic-form-of-promise">Basic form of promise</h2>
<p>A promise is an object that has a <code>then</code> method[^1]:</p>
<pre><code>promise.then(onFulfilled, onRejected)
</code></pre><p><code>then</code> is used to specify two callbacks — <code>onFulfilled</code> and <code>onRejected</code> — that are mutually executed when the state of the promise is resolved to either <em>fulfilled</em> or <em>rejected</em>.</p>
<p>In a Petri net, the promise state is represented by a <strong>token</strong> — black disk — that is positioned on a <strong>place</strong>. In the following figure, the token is on the <em>pending</em> place:</p>
<p><img src="http://www.vittoriozaccaria.net/deposit/pending1.png" alt=""></p>
<p>The token can move to another place when the <strong>transition</strong> events — black squares — fire. Transitions can fire only when they are enabled, i.e., only when a predetermined number of tokens (<strong>weight</strong>) is positioned on their input places. Without any particular specification, the weight corresponds to the number of input places. The number of marks emitted into a place, when not explicitly shown, is 1.</p>
<p>When the promise is resolved, the output transition from the pending place is fired. If the promise is fulfilled, the marker &#39;moves&#39; to the fulfilled state:</p>
<p><img src="http://www.vittoriozaccaria.net/deposit/fulfilled1.png" alt=""></p>
<p>Similarly, the token moves to the rejected place if the promise has been rejected. So far so good.</p>
<h2 id="producing-a-new-promise">Producing a new promise</h2>
<p>As shown above, the <code>then</code> method returns a new promise:</p>
<pre><code>p2 = p1.then(onFulfilled, onRejected)
</code></pre><p>Let&#39;s see, with our new visual model, how the execution of the methods is synchronized with the promise itself:</p>
<p><img src="http://www.vittoriozaccaria.net/deposit/then1.png" alt=""></p>
<p>Once <code>p1</code> is fullfilled, the transition event <code>onFulfilled</code> is fired — i.e., the callback <code>onFulfilled</code> is invoked. If the callback (being it <code>onFulfilled</code> or <code>onReject</code>) returns a value, <code>p2</code> will be fulfilled with that value.</p>
<p>On the other hand, if either callback throws an exception, <code>p2</code> is going to be rejected. So listen, if you want to escalate an error when the first promise is rejected, <strong>throw an exception in your <code>onRejected</code> callback</strong>!</p>
<h2 id="creating-synchronization-points-with-promises">Creating synchronization points with promises</h2>
<p>Here I think that the real power of promises is unleashed. If your callbacks — <code>onFulfilled</code> or <code>onRejected</code> — return a promise (let&#39;s call it <code>R</code>) you can make sure that <code>p2</code> is resolved only when both <code>p1</code> and <code>R</code> have been resolved; in fact <a href="http://promises-aplus.github.io/promises-spec/#point-52">according to the specification</a>:</p>
<blockquote>
<p>If either onFulfilled or onRejected returns a promise (call it returnedPromise), promise2 must assume the state of returnedPromise.</p>
</blockquote>
<p>This Petri net allows to understand very well what&#39;s going on:</p>
<p><img src="http://www.vittoriozaccaria.net/deposit/returned_promise1.png" alt=""></p>
<p>Petri nets allow to model these synchronization points very easily. This is done by forcing the number of tokens that can enable a place transition. In fact, the transition of 1 token to the <code>p2-fullfilled</code> place can only be fired when there are two tokens on the input of the commanding transition.</p>
<h2 id="cheat-sheet">Cheat sheet</h2>
<p>I am astonished about how Petri nets allow us to think in a very clear way about how we structure our promise chain. I hope this can be useful for you as it was for me. </p>
<p>You can download the visual cheat sheet for Petri Nets for promises <a href="http://www.vittoriozaccaria.net/deposit/promises_cheat_sheet1.pdf">from this address</a> [pdf].</p>
<h2 id="suggested-readings">Suggested readings</h2>
<ul>
<li>T. Murata — Petri Nets: Properties, Analysis and Applications - 1989, <a href="http://embedded.eecs.berkeley.edu/Respep/Research/hsc/class.F03/ee249/discussionpapers/PetriNets.pdf">Available at this address</a>.</li>
</ul>
<p>[^1]: We are not going to deal with how this object is generated. We assume that some computation has started and an object representing its future value has been created.  </p>
</div>
          <script src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_SVG"></script>
          <div id="disqus_thread" class="post_container__comments"> 
            <script>(function() {
  var disqus_shortname, dsq;

  disqus_shortname = 'vittoriozaccaria';

  dsq = document.createElement('script');

  dsq.type = 'text/javascript';

  dsq.async = true;

  dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';

  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);

}).call(this);

            </script><a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>